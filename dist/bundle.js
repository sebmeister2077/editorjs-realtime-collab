!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.RealtimeCollabPlugin=t():e.RealtimeCollabPlugin=t()}(self,()=>(()=>{"use strict";var e={56(e,t,o){e.exports=function(e){var t=o.nc;t&&e.setAttribute("nonce",t)}},72(e){var t=[];function o(e){for(var o=-1,n=0;n<t.length;n++)if(t[n].identifier===e){o=n;break}return o}function n(e,n){for(var r={},c=[],l=0;l<e.length;l++){var s=e[l],a=n.base?s[0]+n.base:s[0],d=r[a]||0,u="".concat(a," ").concat(d);r[a]=d+1;var f=o(u),h={css:s[1],media:s[2],sourceMap:s[3],supports:s[4],layer:s[5]};if(-1!==f)t[f].references++,t[f].updater(h);else{var v=i(h,n);n.byIndex=l,t.splice(l,0,{identifier:u,updater:v,references:1})}c.push(u)}return c}function i(e,t){var o=t.domAPI(t);return o.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;o.update(e=t)}else o.remove()}}e.exports=function(e,i){var r=n(e=e||[],i=i||{});return function(e){e=e||[];for(var c=0;c<r.length;c++){var l=o(r[c]);t[l].references--}for(var s=n(e,i),a=0;a<r.length;a++){var d=o(r[a]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}r=s}}},113(e){e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var o="",n=void 0!==t[5];return t[4]&&(o+="@supports (".concat(t[4],") {")),t[2]&&(o+="@media ".concat(t[2]," {")),n&&(o+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),o+=e(t),n&&(o+="}"),t[2]&&(o+="}"),t[4]&&(o+="}"),o}).join("")},t.i=function(e,o,n,i,r){"string"==typeof e&&(e=[[null,e,void 0]]);var c={};if(n)for(var l=0;l<this.length;l++){var s=this[l][0];null!=s&&(c[s]=!0)}for(var a=0;a<e.length;a++){var d=[].concat(e[a]);n&&c[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=r),o&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=o):d[2]=o),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),t.push(d))}},t}},523(e,t,o){o.d(t,{A:()=>l});var n=o(601),i=o.n(n),r=o(314),c=o.n(r)()(i());c.push([e.id,".codex-editor__redactor {\n    position: relative;\n}\n\n.cdx-realtime-block--selected .ce-block__content {\n    position: relative;\n}\n\n.cdx-realtime-block--selected:not(.ce-block--drop-target) .ce-block__content::before {\n    content: '';\n    position: absolute;\n    inset: 0px;\n    z-index: -1;\n    background-color: #e1f2ff99;\n}\n\n.cdx-realtime-block--delete-pending .ce-block__content::before {\n    content: '';\n    position: absolute;\n    inset: 0px;\n    z-index: -1;\n    background-color: #E24A4A;\n}\n\n.cdx-realtime-block--selected .ce-block__content [contenteditable] {\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n}\n\n.cdx-realtime-block--selected .ce-block__content img,\n.cdx-realtime-block--selected .ce-block__content .ce-stub {\n    opacity: 0.55;\n}\n\n.cdx-realtime-inline-cursor {\n    position: absolute;\n    background-color: var(--realtime-inline-cursor-color, #0d0c0f);\n    width: 2px;\n    height: 1ch;\n    transform: translateX(-50%);\n    animation: cursor-blink 0.6s 1s infinite alternate ease-in-out;\n    -webkit-animation: cursor-blink 0.6s 1s infinite alternate ease-in-out;\n    -webkit-transform: translateX(-50%);\n    -moz-transform: translateX(-50%);\n    -ms-transform: translateX(-50%);\n    -o-transform: translateX(-50%);\n}\n\n\n@keyframes cursor-blink {\n\n    0%,\n    30% {\n        background-color: var(--realtime-inline-cursor-color, #0d0c0f);\n    }\n\n    100%,\n    70% {\n        background-color: transparent;\n    }\n}\n\n.cdx-realtime-block--locked {\n    pointer-events: none;\n    opacity: 0.6;\n}\n\n\n.cdx-realtime-inline-selection {\n    position: absolute;\n    background-color: var(--realtime-inline-selection-color, #0d0c0f33);\n    opacity: 0.5;\n    pointer-events: none;\n}",""]);const l=c},540(e){e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601(e){e.exports=function(e){return e[1]}},659(e){var t={};e.exports=function(e,o){var n=function(e){if(void 0===t[e]){var o=document.querySelector(e);if(window.HTMLIFrameElement&&o instanceof window.HTMLIFrameElement)try{o=o.contentDocument.head}catch(e){o=null}t[e]=o}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(o)}},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(o){!function(e,t,o){var n="";o.supports&&(n+="@supports (".concat(o.supports,") {")),o.media&&(n+="@media ".concat(o.media," {"));var i=void 0!==o.layer;i&&(n+="@layer".concat(o.layer.length>0?" ".concat(o.layer):""," {")),n+=o.css,i&&(n+="}"),o.media&&(n+="}"),o.supports&&(n+="}");var r=o.sourceMap;r&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,o)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={id:n,exports:{}};return e[n](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.nc=void 0;var n={};function i(e,t,o){var n,i=o||{},r=i.noTrailing,c=void 0!==r&&r,l=i.noLeading,s=void 0!==l&&l,a=i.debounceMode,d=void 0===a?void 0:a,u=!1,f=0;function h(){n&&clearTimeout(n)}function v(){for(var o=arguments.length,i=new Array(o),r=0;r<o;r++)i[r]=arguments[r];var l=this,a=Date.now()-f;function v(){f=Date.now(),t.apply(l,i)}function k(){n=void 0}u||(s||!d||n||v(),h(),void 0===d&&a>e?s?(f=Date.now(),c||(n=setTimeout(d?k:v,e))):v():!0!==c&&(n=setTimeout(d?k:v,void 0===d?e-a:e)))}return v.cancel=function(e){var t=(e||{}).upcomingOnly,o=void 0!==t&&t;h(),u=!o},v}function r(e,t,o){var n=(o||{}).atBegin;return i(e,t,{debounceMode:!1!==(void 0!==n&&n)})}o.d(n,{default:()=>A});var c=o(72),l=o.n(c),s=o(825),a=o.n(s),d=o(659),u=o.n(d),f=o(56),h=o.n(f),v=o(540),k=o.n(v),b=o(113),p=o.n(b),m=o(523),g={};g.styleTagTransform=p(),g.setAttributes=h(),g.insert=u().bind(null,"head"),g.domAPI=a(),g.insertStyleElement=k(),l()(m.A,g),m.A&&m.A.locals&&m.A.locals;var y=function(){return y=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},y.apply(this,arguments)},S=function(e,t,o,n){return new(o||(o=Promise))(function(i,r){function c(e){try{s(n.next(e))}catch(e){r(e)}}function l(e){try{s(n.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(c,l)}s((n=n.apply(e,t||[])).next())})},I=function(e,t){var o,n,i,r={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=l(0),c.throw=l(1),c.return=l(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function l(l){return function(s){return function(l){if(o)throw new TypeError("Generator is already executing.");for(;c&&(c=0,l[0]&&(r=0)),r;)try{if(o=1,n&&(i=2&l[0]?n.return:l[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,l[1])).done)return i;switch(n=0,i&&(l=[2&l[0],i.value]),l[0]){case 0:case 1:i=l;break;case 4:return r.label++,{value:l[1],done:!1};case 5:r.label++,n=l[1],l=[0];continue;case 7:l=r.ops.pop(),r.trys.pop();continue;default:if(!((i=(i=r.trys).length>0&&i[i.length-1])||6!==l[0]&&2!==l[0])){r=0;continue}if(3===l[0]&&(!i||l[1]>i[0]&&l[1]<i[3])){r.label=l[1];break}if(6===l[0]&&r.label<i[1]){r.label=i[1],i=l;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(l);break}i[2]&&r.ops.pop(),r.trys.pop();continue}l=t.call(e,r)}catch(e){l=[6,e],n=0}finally{o=i=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},E=function(e,t){var o={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(o[n[i]]=e[n[i]])}return o},C=function(e,t,o){if(o||2===arguments.length)for(var n,i=0,r=t.length;i<r;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},B="block-selection-change",x="block-deletion-change",L="user-disconnected",N="block-locked",T="block-unlocked";const A=function(){function e(e){var t=this,o=e.editor,n=e.socket,i=e.socketMethodName,c=E(e,["editor","socket","socketMethodName"]);this._isListening=!1,this._currentEditorLockingBlockId=null,this._lockedBlocks=[],this._customToolsInternalState={},this._remoteSelections=new Map,this.ignoreEvents={},this.throttledBlockChange=void 0,this.throttledInlineSelectionChange=void 0,this._debouncedBlockUnlockingsMap={},this.localBlockStates={},this.editorBlockEvent="block changed",this.editorDomChangedEvent="redactor dom changed",this.blockIdAttributeName="data-id",this.inlineFakeCursorAttributeName="data-realtime-fake-inline-cursor",this.inlineFakeSelectionAttributeName="data-realtime-fake-inline-selection",this.connectionIdAttributeName="data-realtime-connection-id",this.onInlineSelectionChange=function(e){var o,n,i,r,c=document.getSelection();if(c){var l=c.anchorNode,s=c.anchorOffset,a=c.focusOffset;if(l&&t.isNodeInsideOfEditor(l)){var d=l.parentElement;if(d){for(var u=[],f=c.getRangeAt(0).getClientRects(),h=0;h<f.length;h++){var v=f.item(h);v&&u.push(v)}var k=t.getContentAndBlockIdFromNode(l);if(k){var b=k.blockId,p=k.contentElement,m=p.getBoundingClientRect(),g=(u.map(function(e){return{top:e.top-m.top,left:e.left-m.left,width:e.width}}),t.getNodeRelativeChildIndex(l));if(null!==g){var y={type:"inline-selection-change",blockId:b,elementXPath:t.getElementXPath(d),containerWidth:p.clientWidth,anchorOffset:s,focusOffset:a,elementNodeIndex:g,color:null!==(n=null===(o=t.config.cursor)||void 0===o?void 0:o.color)&&void 0!==n?n:"",selectionColor:null!==(r=null===(i=t.config.cursor)||void 0===i?void 0:i.selectionColor)&&void 0!==r?r:"",connectionId:t.socket.connectionId};t.socket.send(t.socketMethodName,y)}}}}}},this.onDisconnect=function(e){t.socket.send(t.socketMethodName,{type:L,connectionId:t.socket.connectionId})},this.onReceiveChange=function(e){var o,n,i,r,c,l,s,a,d,u;switch(e.type){case"block-added":var f=e.index,h=e.block;t.addBlockToIgnoreListUntilNextRender(h.id,e.type),t.editor.blocks.insert(h.tool,h.data,null,f,!1,!1,h.id),t.config.toolsWithDataCheck.includes(h.tool)&&(t._customToolsInternalState[h.id]={data:h.data,tunes:null!==(o=h.tunes)&&void 0!==o?o:{}});break;case"block-changed":var v=e.index,k=e.block;t.addBlockToIgnoreListUntilNextRender(k.id,e.type),t.config.toolsWithDataCheck.includes(k.tool)&&(t._customToolsInternalState[k.id]={data:k.data,tunes:null!==(n=k.tunes)&&void 0!==n?n:{}});var b=null===(i=t.getDOMBlockById(k.id))||void 0===i?void 0:i.classList;if(!(G=t.editor.blocks.getById(k.id)))return;t.editor.blocks.update(k.id,k.data).catch(function(e){e.message==='Block with id "'.concat(k.id,'" not found')&&(t.addBlockToIgnoreListUntilNextRender(k.id,"block-added"),t.editor.blocks.insert(k.tool,k.data,null,v,!1,!1,k.id))}).then(function(){var e,o=t.lockedBlocks.find(function(e){return e.blockId===k.id&&e.connectionId!==t.socket.connectionId});if(o&&t.renderLockedBlocks([],[o]),null==b?void 0:b.contains(t.CSS.selected)){var n=t.getDOMBlockById(k.id);if(!n)return;n.classList.add(t.CSS.selected),(null===(e=t.config.overrideStyles)||void 0===e?void 0:e.selectedClass)&&n.classList.add(t.config.overrideStyles.selectedClass)}});break;case"block-moved":var p=e.toBlockId,m=e.fromBlockId,g=e.toBlockIndex,y=t.editor.blocks.getBlockIndex(p),S=t.editor.blocks.getBlockIndex(m);if(g===S)return;t.addBlockToIgnoreListUntilNextRender(m,e.type),t.editor.blocks.move(y,S);var I=t.getFakeSelections({blockId:m});null==I||I.forEach(function(e){return e.remove()});var E=t.getFakeSelections({blockId:p});null==E||E.forEach(function(e){return e.remove()});var B=t.getFakeCursors({blockId:m});null==B||B.forEach(function(e){return e.remove()});var x=t.getFakeCursors({blockId:p});null==x||x.forEach(function(e){return e.remove()}),t._remoteSelections.forEach(function(e,o){e.blockId!==m&&e.blockId!==p||t._remoteSelections.delete(o)});break;case"block-removed":var L=e.blockId;t.addBlockToIgnoreListUntilNextRender(L,e.type);var A=t.editor.blocks.getBlockIndex(L),O=null!==(c=null===(r=t.editor.blocks.getBlockByIndex(A))||void 0===r?void 0:r.name)&&void 0!==c?c:"";t.editor.blocks.delete(A),t.config.toolsWithDataCheck.includes(O)&&delete t._customToolsInternalState[L],null==(K=t.getFakeSelections({blockId:L}))||K.forEach(function(e){return e.remove()}),null==(X=t.getFakeCursors({blockId:L}))||X.forEach(function(e){return e.remove()}),t._remoteSelections.forEach(function(e,o){e.blockId===L&&t._remoteSelections.delete(o)});break;case"block-selection-change":var M=e.blockId,_=e.isSelected;if(t.addBlockToIgnoreListUntilNextRender(M,e.type),!(h=t.getDOMBlockById(M)))return;_?(h.classList.add(t.CSS.selected),(null===(l=t.config.overrideStyles)||void 0===l?void 0:l.selectedClass)&&h.classList.add(t.config.overrideStyles.selectedClass)):(h.classList.remove(t.CSS.selected),(null===(s=t.config.overrideStyles)||void 0===s?void 0:s.selectedClass)&&h.classList.remove(t.config.overrideStyles.selectedClass));break;case"block-deletion-change":M=e.blockId;var w=e.isDeletePending;if(t.addBlockToIgnoreListUntilNextRender(M,e.type),!(h=t.getDOMBlockById(M)))return;w?(h.classList.add(t.CSS.deletePending),(null===(a=t.config.overrideStyles)||void 0===a?void 0:a.pendingDeletionClass)&&h.classList.add(t.config.overrideStyles.pendingDeletionClass)):(h.classList.remove(t.CSS.deletePending),(null===(d=t.config.overrideStyles)||void 0===d?void 0:d.pendingDeletionClass)&&h.classList.remove(t.config.overrideStyles.pendingDeletionClass));break;case"inline-selection-change":e.type;var R=e.elementXPath,D=(M=e.blockId,e.connectionId),F=e.anchorOffset,j=e.elementNodeIndex,P=e.focusOffset,U=e.color,H=e.selectionColor;if(!(null===(u=t.getDOMBlockById(M))||void 0===u?void 0:u.querySelector(".".concat(t.EditorCSS.blockContent))))return;if(null===R){t._remoteSelections.delete(D);var q=t.getFakeCursors({connectionId:D});null==q||q.forEach(function(e){return e.remove()});var z=t.getFakeSelections({connectionId:D});null==z||z.forEach(function(e){return e.remove()})}else t._remoteSelections.set(D,{elementXPath:R,blockId:M,connectionId:D,anchorOffset:F,focusOffset:P,elementNodeIndex:j,color:U,selectionColor:H}),t.renderRemoteSelection(D);break;case"user-disconnected":var W=e.connectionId,X=t.getFakeCursors({connectionId:W});null==(K=t.getFakeSelections({connectionId:W}))||K.forEach(function(e){return e.remove()}),null==X||X.forEach(function(e){return e.remove()}),t._remoteSelections.delete(W),t.lockedBlocks=t.lockedBlocks.filter(function(e){return e.connectionId!==W});break;case N:var G,J=e.blockId;if(D=e.connectionId,t.lockedBlocks.some(function(e){return e.blockId===J}))break;if(t.lockedBlocks=C(C([],t.lockedBlocks,!0),[{blockId:J,connectionId:D}],!1),t.addBlockToIgnoreListUntilNextRender(J,"block-changed"),!(G=t.editor.blocks.getById(J)))return;var K,Q=t.getElementXPath(G.holder);t.addStyleToDOM(Q,{animationName:"none"},J),null==(X=t.getFakeCursors({blockId:J}))||X.forEach(function(e){return e.remove()}),null==(K=t.getFakeSelections({blockId:J}))||K.forEach(function(e){return e.remove()});break;case T:var V=e.blockId,Y=e.connectionId;t.lockedBlocks=t.lockedBlocks.filter(function(e){return!(e.blockId===V&&e.connectionId===Y)}),t.addBlockToIgnoreListUntilNextRender(V,"block-changed"),t.removeStyleFromDOM(V)}},this.onEditorBlockEvent=function(e){return S(t,void 0,void 0,function(){var t,o,n,i,r,c,l,s,a,d,u,f,h=this;return I(this,function(v){switch(v.label){case 0:return(null==e?void 0:e.event)instanceof CustomEvent&&e.event?(t=e.event,this.validateEventDetail(t)?(o=t.type,n=t.detail,i=n.target,(r=E(n,["target"])).type=o,c=i.id,(null===(d=this.ignoreEvents[c])||void 0===d?void 0:d.has(o))||this.lockedBlocks.some(function(e){return e.blockId===c&&e.connectionId!==h.socket.connectionId})?[2]:(l=this.config.toolsWithDataCheck.includes(i.name),"block-changed"!==o?[3,3]:l?[4,i.save()]:[3,2])):[2]):(console.error("block changed but its not custom event"),[2]);case 1:if(!(s=v.sent()))return[2];if(a={data:s.data,tunes:s.tunes},this.compareToolsData(this._customToolsInternalState[c],a)&&this._currentEditorLockingBlockId!==c)return[2];this._customToolsInternalState[c]=a,v.label=2;case 2:this._currentEditorLockingBlockId==c||(this._currentEditorLockingBlockId=c,this.socket.send(this.socketMethodName,{type:N,blockId:c,connectionId:this.socket.connectionId}),null===(u=this.getFakeCursors({blockId:c}))||void 0===u||u.forEach(function(e){return e.remove()}),null===(f=this.getFakeSelections({blockId:c}))||void 0===f||f.forEach(function(e){return e.remove()})),this.debouncedBlockUnlocking(c,this.socket.connectionId),v.label=3;case 3:return setTimeout(function(){return S(h,void 0,void 0,function(){var e,t,n,s,a,d,u,f,h,v=this;return I(this,function(k){switch(k.label){case 0:return"block-changed"===o?"index"in r&&"number"==typeof r.index?(null===(d=this.throttledBlockChange)||void 0===d||d.call(this,i,null!==(u=r.index)&&void 0!==u?u:0),setTimeout(function(){var e;null===(e=v.throttledInlineSelectionChange)||void 0===e||e.call(v,new CustomEvent("selectionchange"))},0),[2]):[2]:[4,i.save()];case 1:return(e=k.sent())?("block-added"===(t={type:o,block:e}).type&&(t.index=r.index,l&&(this._customToolsInternalState[c]={data:e.data,tunes:null!==(f=e.tunes)&&void 0!==f?f:{}})),"block-removed"===t.type&&(t.blockId=c,l&&delete this._customToolsInternalState[c]),"block-moved"===t.type&&(s=(n=r).fromIndex,a=n.toIndex,t.fromBlockId=c,t.toBlockIndex=a,t.toBlockId=null===(h=this.editor.blocks.getBlockByIndex(s))||void 0===h?void 0:h.id),this.socket.send(this.socketMethodName,t),[2]):[2]}})})},0),[2]}})})},this.editor=o,this.socket=n,this.socket.connectionId||(console.error("{connectionId} is not set for EditorJSGroupCollab plugin. Some features might not work"),this.socket.connectionId="random-"+crypto.randomUUID()),this.socketMethodName=null!=i?i:"editorjs-update",this.config=y(y({},{blockChangeThrottleDelay:300,blockLockDebounceTime:1500,toolsWithDataCheck:["table"]}),null!=c?c:{}),this.redactorObserver=new MutationObserver(function(e,o){for(var n=0,i=e;n<i.length;n++){var r=i[n];t.handleMutation(r)}}),this.toolboxObserver=new MutationObserver(function(e,o){var n=e[e.length-1];n&&t.handleToolboxMutation(n)}),this.resizeObserver=new ResizeObserver(r(100,function(){t.rerenderAllRemoteSelections()})),this.editorStyleElement=document.createElement("style"),this.setupStyleElement(),this.setupThrottledListeners(),this.initializeCustomToolsState()}return Object.defineProperty(e.prototype,"isListening",{get:function(){return this._isListening},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lockedBlocks",{get:function(){return this._lockedBlocks.map(function(e){return y({},e)})},set:function(e){var t=this._lockedBlocks;this._lockedBlocks=e.map(function(e){return y({},e)}),this.renderLockedBlocks(t,this._lockedBlocks)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentLockedBlockId",{get:function(){return this._currentEditorLockingBlockId},enumerable:!1,configurable:!0}),e.prototype.unlisten=function(){this.socket.off(this.socketMethodName),this.editor.off(this.editorBlockEvent,this.onEditorBlockEvent),this.redactorObserver.disconnect(),this.toolboxObserver.disconnect(),this.resizeObserver.disconnect(),document.removeEventListener("selectionchange",this.throttledInlineSelectionChange),window.removeEventListener("beforeunload",this.onDisconnect,{capture:!0}),this.socket.send(this.socketMethodName,{type:L,connectionId:this.socket.connectionId}),this._isListening=!1},e.prototype.listen=function(){var e,t;this.socket.on(this.socketMethodName,this.onReceiveChange),this.editor.on(this.editorBlockEvent,this.onEditorBlockEvent);var o=this.getRedactor();if(o){this.redactorObserver.observe(o,{childList:!0,attributes:!0,attributeFilter:["class"],subtree:!0});var n=null!==(t=null===(e=this.getEditorHolder())||void 0===e?void 0:e.querySelector(".".concat(this.EditorCSS.toolbarSettings)))&&void 0!==t?t:document.querySelector(".".concat(this.EditorCSS.toolbarSettings));n?this.toolboxObserver.observe(n,{childList:!0,attributes:!0,attributeFilter:["class"],subtree:!0}):console.error("Could not initialize toolbox observer.");var i=this.getEditorHolder();i?this.resizeObserver.observe(i):console.error("Could not initialize resize observer."),document.addEventListener("selectionchange",this.throttledInlineSelectionChange),window.addEventListener("beforeunload",this.onDisconnect,{capture:!0}),this._isListening=!0}else console.error("Could not initialize redactor observer.")},Object.defineProperty(e.prototype,"CSS",{get:function(){return{selected:"cdx-realtime-block--selected",inlineCursor:"cdx-realtime-inline-cursor",inlineSelection:"cdx-realtime-inline-selection",deletePending:"cdx-realtime-block--delete-pending",lockedBlock:"cdx-realtime-block--locked"}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"EditorCSS",{get:function(){return{baseBlock:"ce-block",focused:"ce-block--focused",selected:"ce-block--selected",editorWrapper:"codex-editor",editorRedactor:"codex-editor__redactor",blockContent:"ce-block__content",toolbar:"ce-toolbar",toolbarSettings:"ce-settings",toolbarDeleteSetting:"[data-item-name='delete']",table:{row:"tc-row",cell:"tc-cell"}}},enumerable:!1,configurable:!0}),e.prototype.handleMutation=function(e){var t,o,n,i;if("attributes"===e.type){var r=e.target;if(r instanceof HTMLElement){var c=r.classList.contains(this.EditorCSS.selected),l=(r.classList.contains(this.EditorCSS.focused),r.getAttribute(this.blockIdAttributeName));if(l){if((null===(t=this.localBlockStates[l])||void 0===t?void 0:t.has("selected"))!=c){if(null===(o=this.ignoreEvents[l])||void 0===o?void 0:o.has(B))return;null!==(n=(i=this.localBlockStates)[l])&&void 0!==n||(i[l]=new Set),c?this.localBlockStates[l].add("selected"):this.localBlockStates[l].delete("selected"),this.socket.send(this.socketMethodName,{type:B,blockId:l,isSelected:c})}this.localBlockStates[l].size||delete this.localBlockStates[l]}}}},e.prototype.handleToolboxMutation=function(e){var t,o,n,i,r,c=e.target;if(c instanceof HTMLElement){var l=""===c.innerHTML,s=this.editor.blocks.getCurrentBlockIndex(),a=this.editor.blocks.getBlockByIndex(s);if(a){var d=!1;if(!l){var u=null===(t=this.getEditorHolder())||void 0===t?void 0:t.querySelector(".".concat(this.EditorCSS.toolbar," ").concat(this.EditorCSS.toolbarDeleteSetting));if(!(u instanceof HTMLElement))return;d=u.classList.contains("ce-popover-item--confirmation")}var f=a.id;if((null===(o=this.localBlockStates[f])||void 0===o?void 0:o.has("deleting"))!=d){if(null===(n=this.ignoreEvents[f])||void 0===n?void 0:n.has(x))return;null!==(i=(r=this.localBlockStates)[f])&&void 0!==i||(r[f]=new Set),d?this.localBlockStates[f].add("deleting"):this.localBlockStates[f].delete("deleting"),this.socket.send(this.socketMethodName,{type:x,blockId:f,isDeletePending:d})}}}},e.prototype.setupThrottledListeners=function(){var e=this;this.throttledInlineSelectionChange=i(this.config.blockChangeThrottleDelay,function(t){e.isListening&&e.onInlineSelectionChange(t)}),this.throttledBlockChange=i(this.config.blockChangeThrottleDelay,function(t,o){return S(e,void 0,void 0,function(){var e,n,i;return I(this,function(r){switch(r.label){case 0:return this.isListening?(e=t.id,[4,t.save()]):[2];case 1:return(n=r.sent())?(this.applyNeccessaryChanges(t,n),i={type:"block-changed",block:n,index:o},this.isListening?(this.socket.send(this.socketMethodName,i),this.addBlockToIgnoreListUntilNextRender(e,"block-changed"),[2]):[2]):[2]}})})})},e.prototype.debouncedBlockUnlocking=function(e,t){var o,n,i=this,c=null===(n=this._debouncedBlockUnlockingsMap)||void 0===n?void 0:n[e];if(c)c(e,t);else{var l=r(this.config.blockLockDebounceTime,function(e,t){var o;i.socket.send(i.socketMethodName,{type:T,blockId:e,connectionId:t}),i.currentLockedBlockId===e&&(i._currentEditorLockingBlockId=null),null===(o=i._debouncedBlockUnlockingsMap)||void 0===o||delete o[e]});this._debouncedBlockUnlockingsMap=y(y({},this._debouncedBlockUnlockingsMap),((o={})[e]=l,o)),l(e,t)}},e.prototype.getFakeCursors=function(e){var t,o=e.blockId,n=e.connectionId;if(!o&&!n)return null;var i=n?"[".concat(this.connectionIdAttributeName,"='").concat(n,"']"):"",r=o?"[".concat(this.inlineFakeCursorAttributeName,"='").concat(o,"']"):"";return null===(t=this.getEditorHolder())||void 0===t?void 0:t.querySelectorAll("".concat(r).concat(i))},e.prototype.createFakeCursor=function(e){var t=e.blockId,o=e.connectionId,n=document.createElement("div");return n.setAttribute(this.inlineFakeCursorAttributeName,t),n.setAttribute(this.connectionIdAttributeName,o),n.classList.add(this.CSS.inlineCursor),n},e.prototype.getFakeSelections=function(e){var t,o=e.blockId,n=e.connectionId,i=n?"[".concat(this.connectionIdAttributeName,"='").concat(n,"']"):"";return null===(t=this.getEditorHolder())||void 0===t?void 0:t.querySelectorAll("[".concat(this.inlineFakeSelectionAttributeName).concat(o?"='".concat(o,"'"):"","]").concat(i))},e.prototype.createSelectionElement=function(e){var t,o=e.blockId,n=e.connectionId,i=document.createElement("div");return i.setAttribute(this.inlineFakeSelectionAttributeName,o),i.setAttribute(this.connectionIdAttributeName,n),i.classList.add(this.CSS.inlineSelection),(null===(t=this.config.overrideStyles)||void 0===t?void 0:t.inlineSelectionClass)&&i.classList.add(this.config.overrideStyles.inlineSelectionClass),i},e.prototype.validateEventDetail=function(e){return"object"==typeof e.detail&&e.detail&&("index"in e.detail&&"number"==typeof e.detail.index||"fromIndex"in e.detail&&"number"==typeof e.detail.fromIndex&&"toIndex"in e.detail&&"number"==typeof e.detail.toIndex)&&"target"in e.detail&&"object"==typeof e.detail.target&&e.detail.target},e.prototype.addBlockToIgnoreListUntilNextRender=function(e,t){var o=this;this.addBlockToIgnorelist(e,t),setTimeout(function(){o.removeBlockFromIgnorelist(e,t)},0)},e.prototype.addBlockToIgnorelist=function(e,t){this.ignoreEvents[e]||(this.ignoreEvents[e]=new Set),this.ignoreEvents[e].add(t)},e.prototype.removeBlockFromIgnorelist=function(e,t){this.ignoreEvents[e]&&(this.ignoreEvents[e].delete(t),this.ignoreEvents[e].size||delete this.ignoreEvents[e])},e.prototype.addStyleToDOM=function(e,t,o){var n=this.editorStyleElement;if(n){var i=this.stringifyStyles(t),r=document.createComment("nonce: ".concat(o));n.insertAdjacentText("beforeend","".concat(e," {  ").concat(i," }")),n.insertBefore(r,n.lastChild)}},e.prototype.removeStyleFromDOM=function(e){var t,o=this.editorStyleElement;if(o){var n=Array.from(o.childNodes).filter(function(e){return e.nodeType===Node.COMMENT_NODE}).find(function(t){return t.data.trim()==="nonce: ".concat(e)});n&&(null===(t=n.nextSibling)||void 0===t||t.remove(),n.remove())}},e.prototype.stringifyStyles=function(e){var t=new CSSStyleSheet;t.insertRule(":root {}");var o=t.cssRules[0];if(o&&o instanceof CSSStyleRule)return Object.assign(o.style,e),o.style.cssText},e.prototype.getDOMBlockById=function(e){var t,o=null===(t=this.getEditorHolder())||void 0===t?void 0:t.querySelector("[".concat(this.blockIdAttributeName,"='").concat(e,"']"));return o instanceof HTMLElement?o:null},e.prototype.getRedactor=function(){var e,t,o,n,i=null!==(n=null!==(t=null===(e=this.editor)||void 0===e?void 0:e.ui.redactor)&&void 0!==t?t:null===(o=this.getEditorHolder())||void 0===o?void 0:o.querySelector(".".concat(this.EditorCSS.editorRedactor)))&&void 0!==n?n:document.querySelector(".".concat(this.EditorCSS.editorRedactor));return i instanceof HTMLElement?i:null},e.prototype.getEditorHolder=function(){var e,t,o,n;return null!==(n=null!==(t=null===(e=this.editor)||void 0===e?void 0:e.ui.wrapper)&&void 0!==t?t:document.querySelector("#".concat(null===(o=this.editor)||void 0===o?void 0:o.configuration.holder," .").concat(this.EditorCSS.editorWrapper)))&&void 0!==n?n:document.querySelector(".".concat(this.EditorCSS.editorWrapper))},e.prototype.renderLockedBlocks=function(e,t){for(var o,n,i=e.filter(function(e){return!t.some(function(t){return t.blockId===e.blockId&&t.connectionId===e.connectionId})}),r=t.filter(function(t){return!e.some(function(e){return e.blockId===t.blockId&&e.connectionId===t.connectionId})}),c="data-realtime-collab-locked",l=0,s=i;l<s.length;l++){var a=s[l];if(h=this.getDOMBlockById(a.blockId)){var d=h.querySelectorAll('[contenteditable="false"]['.concat(c,"]"));h.classList.remove(this.CSS.lockedBlock),d.forEach(function(e){e.setAttribute("contenteditable","true"),e.removeAttribute(c)}),(null===(o=this.config.overrideStyles)||void 0===o?void 0:o.lockedBlockClass)&&h.classList.remove(this.config.overrideStyles.lockedBlockClass)}}for(var u=0,f=r;u<f.length;u++){var h;a=f[u],(h=this.getDOMBlockById(a.blockId))&&((d=h.querySelectorAll('[contenteditable="true"]')).forEach(function(e){e.setAttribute("contenteditable","false"),e.setAttribute(c,"")}),h.classList.add(this.CSS.lockedBlock),(null===(n=this.config.overrideStyles)||void 0===n?void 0:n.lockedBlockClass)&&h.classList.add(this.config.overrideStyles.lockedBlockClass))}},e.prototype.compareToolsData=function(e,t){return function e(t,o){if(typeof t!=typeof o)return!1;if("object"!=typeof t||null===t||null===o)return t===o;var n=Object.keys(t),i=Object.keys(o);if(n.length!==i.length)return!1;for(var r=0,c=n;r<c.length;r++){var l=c[r];if(!i.includes(l))return!1;if(!e(t[l],o[l]))return!1}return!0}(e,t)},e.prototype.initializeCustomToolsState=function(){for(var e,t,o,n=0,i=null!==(t=null===(e=this.editor.configuration.data)||void 0===e?void 0:e.blocks)&&void 0!==t?t:[];n<i.length;n++){var r=i[n];this.config.toolsWithDataCheck.includes(r.type)&&(this._customToolsInternalState[r.id]={data:r.data,tunes:null!==(o=r.tunes)&&void 0!==o?o:{}})}},e.prototype.setupStyleElement=function(){var e;this.editorStyleElement.setAttribute("data-realtime-collab-styles",""),null===(e=this.getEditorHolder())||void 0===e||e.insertAdjacentElement("afterbegin",this.editorStyleElement)},e.prototype.getContentAndBlockIdFromNode=function(e){var t,o=this;if(!this.isNodeInsideOfEditor(e))return null;for(var n=e.parentElement,i=function(e){var t;return(null==e?void 0:e.classList.contains(o.EditorCSS.blockContent))&&(null===(t=null==e?void 0:e.parentElement)||void 0===t?void 0:t.classList.contains(o.EditorCSS.baseBlock))&&(null==e?void 0:e.parentElement.hasAttribute(o.blockIdAttributeName))};n&&!i(n);)n=n.parentElement;if(!n)return null;var r=null===(t=n.parentElement)||void 0===t?void 0:t.getAttribute(this.blockIdAttributeName);return r?{contentElement:n,blockId:r}:null},e.prototype.getBoundingClientRectForSelection=function(e,t,o){var n=document.createRange(),i=Math.min(t,o),r=Math.max(t,o);return n.setStart(e,i),n.setEnd(e,r),n.getClientRects()},e.prototype.isNodeInsideOfEditor=function(e){var t,o,n,i,r,c,l=null===(n=null===(o=null===(t=this.editor)||void 0===t?void 0:t.ui)||void 0===o?void 0:o.nodes)||void 0===n?void 0:n.redactor;if(l instanceof HTMLElement)return l.contains(e);var s=null===(r=null===(i=this.editor)||void 0===i?void 0:i.configuration)||void 0===r?void 0:r.holder;if(s&&"string"==typeof s)return null===(c=document.getElementById(s))||void 0===c?void 0:c.contains(e);for(var a=e.parentElement;a&&a!==document.body;){var d=a.getAttribute(this.blockIdAttributeName),u=a.classList.contains(this.EditorCSS.baseBlock),f=d&&Boolean(this.editor.blocks.getById(d));if(u&&f)return!0;a=a.parentElement}return!1},e.prototype.getElementXPath=function(e,t){void 0===t&&(t=!1);for(var o=e,n=[];o.parentNode instanceof HTMLElement&&!o.classList.contains(this.EditorCSS.editorRedactor);){var i=o.getAttribute(this.blockIdAttributeName),r=o.localName.toLowerCase();if(i&&(r+="[".concat(this.blockIdAttributeName,"='").concat(i,"']")),(!t||!i)&&o.previousElementSibling){for(var c=o,l=1;c=c.previousElementSibling;)l++;r+=":nth-child(".concat(l,")")}n.unshift(r),o=o.parentNode}return n.unshift(".".concat(this.EditorCSS.editorRedactor)),n.join(" > ")},e.prototype.getNodeRelativeChildIndex=function(e){var t=e.parentElement;if(!t)return null;for(var o=0;o<t.childNodes.length;o++)if(e===t.childNodes[o])return o;return null},e.prototype.applyNeccessaryChanges=function(e,t){var o=this;"table"===e.name&&e.holder.querySelectorAll(".".concat(this.EditorCSS.table.row)).forEach(function(e,n){var i,r=Array.from(e.querySelectorAll(".".concat(o.EditorCSS.table.cell))),c=r.every(function(e){var t;return!(null===(t=e.textContent)||void 0===t?void 0:t.trim())});if(c){var l=null===(i=t.data)||void 0===i?void 0:i.content;l instanceof Array&&l.splice(n,0,r.map(function(e){return e.textContent}))}})},e.prototype.calculateRelativeRects=function(e,t,o){var n=o.clientWidth;if(t===n)return e;var i=n<t;if(e[0],i);else for(var r=0,c=e;r<c.length;r++)c[r];return[]},e.prototype.renderRemoteSelection=function(e){var t,o,n,i,r=this._remoteSelections.get(e);if(r){var c=r.elementXPath,l=r.blockId,s=r.anchorOffset,a=r.focusOffset,d=r.elementNodeIndex,u=r.color,f=r.selectionColor,h=this.getEditorHolder();if(h){var v=h.querySelector(c);if(v instanceof HTMLElement){var k=v.childNodes[d];if(k){var b=this.getBoundingClientRectForSelection(k,s,a),p=h.getBoundingClientRect(),m=s!==a;if(null===(o=this.getFakeCursors({connectionId:e}))||void 0===o||o.forEach(function(e){return e.remove()}),null===(n=this.getFakeSelections({connectionId:e}))||void 0===n||n.forEach(function(e){return e.remove()}),m){for(var g=0;g<b.length;g++)if(S=b.item(g)){var y=this.createSelectionElement({blockId:l,connectionId:e});y.style.top="".concat(S.top-p.top,"px"),y.style.left="".concat(S.left-p.left,"px"),y.style.width="".concat(S.width,"px"),y.style.height="".concat(S.height,"px"),f&&y.style.setProperty("--realtime-inline-selection-color",f),h.insertAdjacentElement("beforeend",y)}this.addBlockToIgnoreListUntilNextRender(l,"block-changed")}else{var S,I=this.createFakeCursor({connectionId:e,blockId:l});if(!(S=b.item(0)))return;var E=h.querySelector(c);if(!(E instanceof HTMLElement))return;var C=window.getComputedStyle(E).fontSize;I.style.height=C,I.style.top="".concat(S.top-p.top,"px"),I.style.left="".concat(S.left-p.left,"px");var B=(null!==(i=this.config.overrideStyles)&&void 0!==i?i:{}).cursorClass;u&&I.style.setProperty("--realtime-inline-cursor-color",u),B&&(t=I.classList).add.apply(t,B.split(" ")),h.insertAdjacentElement("beforeend",I)}}}}}},e.prototype.rerenderAllRemoteSelections=function(){var e=this;this._remoteSelections.forEach(function(t,o){e.renderRemoteSelection(o)})},e}();return n.default})());