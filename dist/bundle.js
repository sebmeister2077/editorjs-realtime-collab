!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.RealtimeCollabPlugin=t():e.RealtimeCollabPlugin=t()}(self,()=>(()=>{"use strict";var e={523(e,t,o){o.d(t,{A:()=>r});var n=o(601),i=o.n(n),s=o(314),c=o.n(s)()(i());c.push([e.id,".codex-editor__redactor {\n    position: relative;\n}\n\n.cdx-realtime-block--selected .ce-block__content {\n    position: relative;\n}\n\n.cdx-realtime-block--selected:not(.ce-block--drop-target) .ce-block__content::before {\n    content: '';\n    position: absolute;\n    inset: 0px;\n    z-index: -1;\n    background-color: #e1f2ff99;\n}\n\n.cdx-realtime-block--delete-pending .ce-block__content::before {\n    content: '';\n    position: absolute;\n    inset: 0px;\n    z-index: -1;\n    background-color: #E24A4A;\n}\n\n.cdx-realtime-block--selected .ce-block__content [contenteditable] {\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n}\n\n.cdx-realtime-block--selected .ce-block__content img,\n.cdx-realtime-block--selected .ce-block__content .ce-stub {\n    opacity: 0.55;\n}\n\n.cdx-realtime-inline-cursor {\n    position: absolute;\n    background-color: var(--realtime-inline-cursor-color, #0d0c0f);\n    width: 2px;\n    height: 1ch;\n    transform: translateX(-50%);\n    animation: cursor-blink 0.6s 1s infinite alternate ease-in-out;\n    -webkit-animation: cursor-blink 0.6s 1s infinite alternate ease-in-out;\n    -webkit-transform: translateX(-50%);\n    -moz-transform: translateX(-50%);\n    -ms-transform: translateX(-50%);\n    -o-transform: translateX(-50%);\n}\n\n\n@keyframes cursor-blink {\n\n    0%,\n    30% {\n        background-color: var(--realtime-inline-cursor-color, #0d0c0f);\n    }\n\n    100%,\n    70% {\n        background-color: transparent;\n    }\n}\n\n.cdx-realtime-block--locked {\n    pointer-events: none;\n    opacity: 0.6;\n}\n\n\n.cdx-realtime-inline-selection {\n    position: absolute;\n    background-color: var(--realtime-inline-selection-color, #0d0c0f33);\n    opacity: 0.5;\n    pointer-events: none;\n}",""]);const r=c},314(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var o="",n=void 0!==t[5];return t[4]&&(o+="@supports (".concat(t[4],") {")),t[2]&&(o+="@media ".concat(t[2]," {")),n&&(o+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),o+=e(t),n&&(o+="}"),t[2]&&(o+="}"),t[4]&&(o+="}"),o}).join("")},t.i=function(e,o,n,i,s){"string"==typeof e&&(e=[[null,e,void 0]]);var c={};if(n)for(var r=0;r<this.length;r++){var l=this[r][0];null!=l&&(c[l]=!0)}for(var d=0;d<e.length;d++){var a=[].concat(e[d]);n&&c[a[0]]||(void 0!==s&&(void 0===a[5]||(a[1]="@layer".concat(a[5].length>0?" ".concat(a[5]):""," {").concat(a[1],"}")),a[5]=s),o&&(a[2]?(a[1]="@media ".concat(a[2]," {").concat(a[1],"}"),a[2]=o):a[2]=o),i&&(a[4]?(a[1]="@supports (".concat(a[4],") {").concat(a[1],"}"),a[4]=i):a[4]="".concat(i)),t.push(a))}},t}},601(e){e.exports=function(e){return e[1]}},72(e){var t=[];function o(e){for(var o=-1,n=0;n<t.length;n++)if(t[n].identifier===e){o=n;break}return o}function n(e,n){for(var s={},c=[],r=0;r<e.length;r++){var l=e[r],d=n.base?l[0]+n.base:l[0],a=s[d]||0,h="".concat(d," ").concat(a);s[d]=a+1;var u=o(h),k={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==u)t[u].references++,t[u].updater(k);else{var f=i(k,n);n.byIndex=r,t.splice(r,0,{identifier:h,updater:f,references:1})}c.push(h)}return c}function i(e,t){var o=t.domAPI(t);return o.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;o.update(e=t)}else o.remove()}}e.exports=function(e,i){var s=n(e=e||[],i=i||{});return function(e){e=e||[];for(var c=0;c<s.length;c++){var r=o(s[c]);t[r].references--}for(var l=n(e,i),d=0;d<s.length;d++){var a=o(s[d]);0===t[a].references&&(t[a].updater(),t.splice(a,1))}s=l}}},659(e){var t={};e.exports=function(e,o){var n=function(e){if(void 0===t[e]){var o=document.querySelector(e);if(window.HTMLIFrameElement&&o instanceof window.HTMLIFrameElement)try{o=o.contentDocument.head}catch(e){o=null}t[e]=o}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(o)}},540(e){e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56(e,t,o){e.exports=function(e){var t=o.nc;t&&e.setAttribute("nonce",t)}},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(o){!function(e,t,o){var n="";o.supports&&(n+="@supports (".concat(o.supports,") {")),o.media&&(n+="@media ".concat(o.media," {"));var i=void 0!==o.layer;i&&(n+="@layer".concat(o.layer.length>0?" ".concat(o.layer):""," {")),n+=o.css,i&&(n+="}"),o.media&&(n+="}"),o.supports&&(n+="}");var s=o.sourceMap;s&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,o)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113(e){e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var s=t[n]={id:n,exports:{}};return e[n](s,s.exports,o),s.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.nc=void 0;var n={};function i(e,t,o){var n,i=o||{},s=i.noTrailing,c=void 0!==s&&s,r=i.noLeading,l=void 0!==r&&r,d=i.debounceMode,a=void 0===d?void 0:d,h=!1,u=0;function k(){n&&clearTimeout(n)}function f(){for(var o=arguments.length,i=new Array(o),s=0;s<o;s++)i[s]=arguments[s];var r=this,d=Date.now()-u;function f(){u=Date.now(),t.apply(r,i)}function b(){n=void 0}h||(l||!a||n||f(),k(),void 0===a&&d>e?l?(u=Date.now(),c||(n=setTimeout(a?b:f,e))):f():!0!==c&&(n=setTimeout(a?b:f,void 0===a?e-d:e)))}return f.cancel=function(e){var t=(e||{}).upcomingOnly,o=void 0!==t&&t;k(),h=!o},f}o.d(n,{default:()=>C});var s=o(72),c=o.n(s),r=o(825),l=o.n(r),d=o(659),a=o.n(d),h=o(56),u=o.n(h),k=o(540),f=o.n(k),b=o(113),m=o.n(b),g=o(523),p={};p.styleTagTransform=m(),p.setAttributes=u(),p.insert=a().bind(null,"head"),p.domAPI=l(),p.insertStyleElement=f(),c()(g.A,p),g.A&&g.A.locals&&g.A.locals;const v="block-selection-change",S="block-deletion-change",I="user-disconnected",y="block-locked",E="block-unlocked";class C{editor;socket;socketMethodName;config;_isListening=!1;_currentEditorLockingBlockId=null;_lockedBlocks=[];_customToolsInternalState={};ignoreEvents={};redactorObserver;toolboxObserver;editorStyleElement;throttledBlockChange=void 0;throttledInlineSelectionChange=void 0;_debouncedBlockUnlockingsMap={};localBlockStates={};editorBlockEvent="block changed";editorDomChangedEvent="redactor dom changed";blockIdAttributeName="data-id";inlineFakeCursorAttributeName="data-realtime-fake-inline-cursor";inlineFakeSelectionAttributeName="data-realtime-fake-inline-selection";connectionIdAttributeName="data-realtime-connection-id";constructor({editor:e,socket:t,socketMethodName:o,...n}){this.editor=e,this.socket=t,this.socket.connectionId||(console.error("{connectionId} is not set for EditorJSGroupCollab plugin. Some features might not work"),this.socket.connectionId="random-"+crypto.randomUUID()),this.socketMethodName=o??"editorjs-update",this.config={blockChangeThrottleDelay:300,blockLockDebounceTime:1500,toolsWithDataCheck:["table"],...n??{}},this.redactorObserver=new MutationObserver((e,t)=>{for(let t of e)this.handleMutation(t)}),this.toolboxObserver=new MutationObserver((e,t)=>{const o=e.at(-1);o&&this.handleToolboxMutation(o)}),this.editorStyleElement=document.createElement("style"),this.setupStyleElement(),this.setupThrottledListeners(),this.initializeCustomToolsState()}get isListening(){return this._isListening}get lockedBlocks(){return this._lockedBlocks.map(e=>({...e}))}set lockedBlocks(e){const t=this._lockedBlocks;this._lockedBlocks=e.map(e=>({...e})),this.renderLockedBlocks(t,this._lockedBlocks)}get currentLockedBlockId(){return this._currentEditorLockingBlockId}unlisten(){this.socket.off(this.socketMethodName),this.editor.off(this.editorBlockEvent,this.onEditorBlockEvent),this.redactorObserver.disconnect(),this.toolboxObserver.disconnect(),document.removeEventListener("selectionchange",this.throttledInlineSelectionChange),window.removeEventListener("beforeunload",this.onDisconnect,{capture:!0}),this.socket.send(this.socketMethodName,{type:I,connectionId:this.socket.connectionId}),this.getFakeCursors({})?.forEach(e=>e.remove()),this.getFakeSelections({})?.forEach(e=>e.remove()),this.lockedBlocks=[],this._isListening=!1}listen(){this.socket.on(this.socketMethodName,this.onReceiveChange),this.editor.on(this.editorBlockEvent,this.onEditorBlockEvent);const e=this.getRedactor();if(!e)return void console.error("Could not initialize redactor observer.");this.redactorObserver.observe(e,{childList:!0,attributes:!0,attributeFilter:["class"],subtree:!0});const t=this.getEditorHolder()?.querySelector(`.${this.EditorCSS.toolbarSettings}`)??document.querySelector(`.${this.EditorCSS.toolbarSettings}`);t?this.toolboxObserver.observe(t,{childList:!0,attributes:!0,attributeFilter:["class"],subtree:!0}):console.error("Could not initialize toolbox observer."),document.addEventListener("selectionchange",this.throttledInlineSelectionChange),window.addEventListener("beforeunload",this.onDisconnect,{capture:!0}),this._isListening=!0}get CSS(){return{selected:"cdx-realtime-block--selected",inlineCursor:"cdx-realtime-inline-cursor",inlineSelection:"cdx-realtime-inline-selection",deletePending:"cdx-realtime-block--delete-pending",lockedBlock:"cdx-realtime-block--locked"}}get EditorCSS(){return{baseBlock:"ce-block",focused:"ce-block--focused",selected:"ce-block--selected",editorWrapper:"codex-editor",editorRedactor:"codex-editor__redactor",blockContent:"ce-block__content",toolbar:"ce-toolbar",toolbarSettings:"ce-settings",toolbarDeleteSetting:"[data-item-name='delete']",table:{row:"tc-row",cell:"tc-cell"}}}handleMutation(e){if("attributes"!==e.type)return;const{target:t}=e;if(!(t instanceof HTMLElement))return;const o=t.classList.contains(this.EditorCSS.selected),n=(t.classList.contains(this.EditorCSS.focused),t.getAttribute(this.blockIdAttributeName));if(n){if(this.localBlockStates[n]?.has("selected")!=o){if(this.ignoreEvents[n]?.has(v))return;this.localBlockStates[n]??=new Set,o?this.localBlockStates[n].add("selected"):this.localBlockStates[n].delete("selected"),this.socket.send(this.socketMethodName,{type:v,blockId:n,isSelected:o})}this.localBlockStates[n].size||delete this.localBlockStates[n]}}handleToolboxMutation(e){const{target:t}=e;if(!(t instanceof HTMLElement))return;const o=""===t.innerHTML,n=this.editor.blocks.getCurrentBlockIndex(),i=this.editor.blocks.getBlockByIndex(n);if(!i)return;let s=!1;if(!o){const e=this.getEditorHolder()?.querySelector(`.${this.EditorCSS.toolbar} ${this.EditorCSS.toolbarDeleteSetting}`);if(!(e instanceof HTMLElement))return;s=e.classList.contains("ce-popover-item--confirmation")}const c=i.id;if(this.localBlockStates[c]?.has("deleting")!=s){if(this.ignoreEvents[c]?.has(S))return;this.localBlockStates[c]??=new Set,s?this.localBlockStates[c].add("deleting"):this.localBlockStates[c].delete("deleting"),this.socket.send(this.socketMethodName,{type:S,blockId:c,isDeletePending:s})}}onInlineSelectionChange=e=>{const t=document.getSelection();if(!t)return;const{anchorNode:o,anchorOffset:n,focusOffset:i}=t;if(!o)return;if(!this.isNodeInsideOfEditor(o))return;const{parentElement:s}=o;if(!s)return;const c=[],r=t.getRangeAt(0).getClientRects();for(let e=0;e<r.length;e++){const t=r.item(e);t&&c.push(t)}const l=this.getContentAndBlockIdFromNode(o);if(!l)return;const{blockId:d,contentElement:a}=l,h=a.getBoundingClientRect(),u=(c.map(e=>({top:e.top-h.top,left:e.left-h.left,width:e.width})),this.getNodeRelativeChildIndex(o));if(null===u)return;const k={type:"inline-selection-change",blockId:d,elementXPath:this.getElementXPath(s),containerWidth:a.clientWidth,anchorOffset:n,focusOffset:i,elementNodeIndex:u,color:this.config.cursor?.color??"",selectionColor:this.config.cursor?.selectionColor??"",connectionId:this.socket.connectionId};this.socket.send(this.socketMethodName,k)};onDisconnect=e=>{this.socket.send(this.socketMethodName,{type:I,connectionId:this.socket.connectionId})};onReceiveChange=e=>{switch(e.type){case"block-added":{const{index:t,block:o}=e;this.addBlockToIgnoreListUntilNextRender(o.id,e.type),this.editor.blocks.insert(o.tool,o.data,null,t,!1,!1,o.id),this.config.toolsWithDataCheck.includes(o.tool)&&(this._customToolsInternalState[o.id]={data:o.data,tunes:o.tunes??{}});break}case"block-changed":{const{index:t,block:o}=e;this.addBlockToIgnoreListUntilNextRender(o.id,e.type),this.config.toolsWithDataCheck.includes(o.tool)&&(this._customToolsInternalState[o.id]={data:o.data,tunes:o.tunes??{}});const n=this.getDOMBlockById(o.id)?.classList;if(!this.editor.blocks.getById(o.id))return;this.editor.blocks.update(o.id,o.data).catch(e=>{e.message===`Block with id "${o.id}" not found`&&(this.addBlockToIgnoreListUntilNextRender(o.id,"block-added"),this.editor.blocks.insert(o.tool,o.data,null,t,!1,!1,o.id))}).then(()=>{const e=this.lockedBlocks.find(e=>e.blockId===o.id&&e.connectionId!==this.socket.connectionId);if(e&&this.renderLockedBlocks([],[e]),n?.contains(this.CSS.selected)){const e=this.getDOMBlockById(o.id);if(!e)return;e.classList.add(this.CSS.selected),this.config.overrideStyles?.selectedClass&&e.classList.add(this.config.overrideStyles.selectedClass)}});break}case"block-moved":{const{toBlockId:t,fromBlockId:o,toBlockIndex:n}=e,i=this.editor.blocks.getBlockIndex(t),s=this.editor.blocks.getBlockIndex(o);if(n===s)return;this.addBlockToIgnoreListUntilNextRender(o,e.type),this.editor.blocks.move(i,s);const c=this.getFakeSelections({blockId:o});c?.forEach(e=>e.remove());const r=this.getFakeSelections({blockId:t});r?.forEach(e=>e.remove());const l=this.getFakeCursors({blockId:o});l?.forEach(e=>e.remove());const d=this.getFakeCursors({blockId:t});d?.forEach(e=>e.remove());break}case"block-removed":{const{blockId:t}=e;this.addBlockToIgnoreListUntilNextRender(t,e.type);const o=this.editor.blocks.getBlockIndex(t),n=this.editor.blocks.getBlockByIndex(o)?.name??"";this.editor.blocks.delete(o),this.config.toolsWithDataCheck.includes(n)&&delete this._customToolsInternalState[t];const i=this.getFakeSelections({blockId:t});i?.forEach(e=>e.remove());const s=this.getFakeCursors({blockId:t});s?.forEach(e=>e.remove());break}case"block-selection-change":{const{blockId:t,isSelected:o}=e;this.addBlockToIgnoreListUntilNextRender(t,e.type);const n=this.getDOMBlockById(t);if(!n)return;o?(n.classList.add(this.CSS.selected),this.config.overrideStyles?.selectedClass&&n.classList.add(this.config.overrideStyles.selectedClass)):(n.classList.remove(this.CSS.selected),this.config.overrideStyles?.selectedClass&&n.classList.remove(this.config.overrideStyles.selectedClass));break}case"block-deletion-change":{const{blockId:t,isDeletePending:o}=e;this.addBlockToIgnoreListUntilNextRender(t,e.type);const n=this.getDOMBlockById(t);if(!n)return;o?(n.classList.add(this.CSS.deletePending),this.config.overrideStyles?.pendingDeletionClass&&n.classList.add(this.config.overrideStyles.pendingDeletionClass)):(n.classList.remove(this.CSS.deletePending),this.config.overrideStyles?.pendingDeletionClass&&n.classList.remove(this.config.overrideStyles.pendingDeletionClass));break}case"inline-selection-change":{const{type:t,elementXPath:o,blockId:n,connectionId:i,anchorOffset:s,elementNodeIndex:c,focusOffset:r,color:l,selectionColor:d}=e,a=this.getDOMBlockById(n)?.querySelector(`.${this.EditorCSS.blockContent}`);if(!a)return;const h=s!==r,u=null===o||h;if(u){const e=this.getFakeCursors({connectionId:i});e?.forEach(e=>e.remove())}const k=this.getEditorHolder();if(!k)return;const f=k.querySelector(o);if(!(f instanceof HTMLElement))return;const b=f.childNodes[c];if(!b)return;const m=this.getBoundingClientRectForSelection(b,s,r),g=k.getBoundingClientRect();if(this.getFakeSelections({connectionId:i})?.forEach(e=>e.remove()),h)for(let e=0;e<m.length;e++){const t=m.item(e);if(!t)continue;const o=this.createSelectionElement({blockId:n,connectionId:i});o.style.top=t.top-g.top+"px",o.style.left=t.left-g.left+"px",o.style.width=`${t.width}px`,o.style.height=`${t.height}px`,d&&o.style.setProperty("--realtime-inline-selection-color",d),k.insertAdjacentElement("beforeend",o),this.addBlockToIgnoreListUntilNextRender(n,"block-changed")}else{let e;u?e=this.createFakeCursor({connectionId:i,blockId:n}):(e=this.getFakeCursors({connectionId:i})?.item(0),e||(e=this.createFakeCursor({connectionId:i,blockId:n})),e.style.animation="none",e.offsetHeight,e.style.animation="");const t=m.item(0);if(!t)return;const s=this.getEditorHolder()?.querySelector(o);if(!(s instanceof HTMLElement))return;const{fontSize:c}=window.getComputedStyle(s);e.style.height=c,e.style.top=t.top-g.top+"px",e.style.left=t.left-g.left+"px";const{cursorClass:r}=this.config.overrideStyles??{};l&&e.style.setProperty("--realtime-inline-cursor-color",l),r&&e.classList.add(...r.split(" ")),k.contains(e)||k.insertAdjacentElement("beforeend",e)}break}case"user-disconnected":{const{connectionId:t}=e,o=this.getFakeCursors({connectionId:t}),n=this.getFakeSelections({connectionId:t});n?.forEach(e=>e.remove()),o?.forEach(e=>e.remove()),this.lockedBlocks=this.lockedBlocks.filter(e=>e.connectionId!==t);break}case y:{const{blockId:t,connectionId:o}=e;if(this.lockedBlocks.some(e=>e.blockId===t))break;this.lockedBlocks=[...this.lockedBlocks,{blockId:t,connectionId:o}],this.addBlockToIgnoreListUntilNextRender(t,"block-changed");const n=this.editor.blocks.getById(t);if(!n)return;const i=this.getElementXPath(n.holder);this.addStyleToDOM(i,{animationName:"none"},t);const s=this.getFakeCursors({blockId:t});s?.forEach(e=>e.remove());const c=this.getFakeSelections({blockId:t});c?.forEach(e=>e.remove());break}case E:{const{blockId:t,connectionId:o}=e;this.lockedBlocks=this.lockedBlocks.filter(e=>!(e.blockId===t&&e.connectionId===o)),this.addBlockToIgnoreListUntilNextRender(t,"block-changed"),this.removeStyleFromDOM(t);break}}};onEditorBlockEvent=async e=>{if(!(e?.event instanceof CustomEvent&&e.event))return void console.error("block changed but its not custom event");const{event:t}=e;if(!this.validateEventDetail(t))return;const o=t.type,{target:n,...i}=t.detail;i.type=o;const s=n.id;if(this.ignoreEvents[s]?.has(o))return;if(this.lockedBlocks.some(e=>e.blockId===s&&e.connectionId!==this.socket.connectionId))return;const c=this.config.toolsWithDataCheck.includes(n.name);if("block-changed"===o){if(c){const e=await n.save();if(!e)return;const t={data:e.data,tunes:e.tunes};if(this.compareToolsData(this._customToolsInternalState[s],t)&&this._currentEditorLockingBlockId!==s)return;this._customToolsInternalState[s]=t}this._currentEditorLockingBlockId==s||(this._currentEditorLockingBlockId=s,this.socket.send(this.socketMethodName,{type:y,blockId:s,connectionId:this.socket.connectionId}),this.getFakeCursors({blockId:s})?.forEach(e=>e.remove()),this.getFakeSelections({blockId:s})?.forEach(e=>e.remove())),this.debouncedBlockUnlocking(s,this.socket.connectionId)}setTimeout(async()=>{if("block-changed"===o){if(!("index"in i)||"number"!=typeof i.index)return;return this.throttledBlockChange?.(n,i.index??0),void setTimeout(()=>{this.throttledInlineSelectionChange?.(new CustomEvent("selectionchange"))},0)}const e=await n.save();if(!e)return;const t={type:o,block:e};if("block-added"===t.type&&(t.index=i.index,c&&(this._customToolsInternalState[s]={data:e.data,tunes:e.tunes??{}})),"block-removed"===t.type&&(t.blockId=s,c&&delete this._customToolsInternalState[s]),"block-moved"===t.type){const{fromIndex:e,toIndex:o}=i;t.fromBlockId=s,t.toBlockIndex=o,t.toBlockId=this.editor.blocks.getBlockByIndex(e)?.id}this.socket.send(this.socketMethodName,t)},0)};setupThrottledListeners(){this.throttledInlineSelectionChange=i(this.config.blockChangeThrottleDelay,e=>{this.isListening&&this.onInlineSelectionChange(e)}),this.throttledBlockChange=i(this.config.blockChangeThrottleDelay,async(e,t)=>{if(!this.isListening)return;const o=e.id,n=await e.save();if(!n)return;this.applyNeccessaryChanges(e,n);const i={type:"block-changed",block:n,index:t};this.isListening&&(this.socket.send(this.socketMethodName,i),this.addBlockToIgnoreListUntilNextRender(o,"block-changed"))})}debouncedBlockUnlocking(e,t){const o=this._debouncedBlockUnlockingsMap?.[e];if(o)return void o(e,t);const n=i(this.config.blockLockDebounceTime,(e,t)=>{this.socket.send(this.socketMethodName,{type:E,blockId:e,connectionId:t}),this.currentLockedBlockId===e&&(this._currentEditorLockingBlockId=null),delete this._debouncedBlockUnlockingsMap?.[e]},{debounceMode:!1!==(void 0!==(s={}.atBegin)&&s)});var s;this._debouncedBlockUnlockingsMap={...this._debouncedBlockUnlockingsMap,[e]:n},n(e,t)}getFakeCursors({blockId:e,connectionId:t}){const o=this.getEditorHolder();if(!e&&!t)return o?.querySelectorAll(`[${this.inlineFakeCursorAttributeName}]`);const n=t?`[${this.connectionIdAttributeName}='${t}']`:"",i=e?`[${this.inlineFakeCursorAttributeName}='${e}']`:"",s=o?.querySelectorAll(`${i}${n}`);return s}createFakeCursor({blockId:e,connectionId:t}){const o=document.createElement("div");return o.setAttribute(this.inlineFakeCursorAttributeName,e),o.setAttribute(this.connectionIdAttributeName,t),o.classList.add(this.CSS.inlineCursor),o}getFakeSelections({blockId:e,connectionId:t}){const o=t?`[${this.connectionIdAttributeName}='${t}']`:"";return this.getEditorHolder()?.querySelectorAll(`[${this.inlineFakeSelectionAttributeName}${e?`='${e}'`:""}]${o}`)}createSelectionElement({blockId:e,connectionId:t}){const o=document.createElement("div");return o.setAttribute(this.inlineFakeSelectionAttributeName,e),o.setAttribute(this.connectionIdAttributeName,t),o.classList.add(this.CSS.inlineSelection),this.config.overrideStyles?.inlineSelectionClass&&o.classList.add(this.config.overrideStyles.inlineSelectionClass),o}validateEventDetail(e){return"object"==typeof e.detail&&e.detail&&("index"in e.detail&&"number"==typeof e.detail.index||"fromIndex"in e.detail&&"number"==typeof e.detail.fromIndex&&"toIndex"in e.detail&&"number"==typeof e.detail.toIndex)&&"target"in e.detail&&"object"==typeof e.detail.target&&e.detail.target}addBlockToIgnoreListUntilNextRender(e,t){this.addBlockToIgnorelist(e,t),setTimeout(()=>{this.removeBlockFromIgnorelist(e,t)},0)}addBlockToIgnorelist(e,t){this.ignoreEvents[e]||(this.ignoreEvents[e]=new Set),this.ignoreEvents[e].add(t)}removeBlockFromIgnorelist(e,t){this.ignoreEvents[e]&&(this.ignoreEvents[e].delete(t),this.ignoreEvents[e].size||delete this.ignoreEvents[e])}addStyleToDOM(e,t,o){const n=this.editorStyleElement;if(!n)return;const i=this.stringifyStyles(t),s=document.createComment(`nonce: ${o}`);n.insertAdjacentText("beforeend",`${e} {  ${i} }`),n.insertBefore(s,n.lastChild)}removeStyleFromDOM(e){const t=this.editorStyleElement;if(!t)return;const o=Array.from(t.childNodes).filter(e=>e.nodeType===Node.COMMENT_NODE).find(t=>t.data.trim()===`nonce: ${e}`);o&&(o.nextSibling?.remove(),o.remove())}stringifyStyles(e){const t=new CSSStyleSheet;t.insertRule(":root {}");const o=t.cssRules[0];if(o&&o instanceof CSSStyleRule)return Object.assign(o.style,e),o.style.cssText}getDOMBlockById(e){const t=this.getEditorHolder()?.querySelector(`[${this.blockIdAttributeName}='${e}']`);return t instanceof HTMLElement?t:null}getRedactor(){const e=this.editor?.ui.redactor??this.getEditorHolder()?.querySelector(`.${this.EditorCSS.editorRedactor}`)??document.querySelector(`.${this.EditorCSS.editorRedactor}`);return e instanceof HTMLElement?e:null}getEditorHolder(){return this.editor?.ui.wrapper??document.querySelector(`#${this.editor?.configuration.holder} .${this.EditorCSS.editorWrapper}`)??document.querySelector(`.${this.EditorCSS.editorWrapper}`)}renderLockedBlocks(e,t){const o=e.filter(e=>!t.some(t=>t.blockId===e.blockId&&t.connectionId===e.connectionId)),n=t.filter(t=>!e.some(e=>e.blockId===t.blockId&&e.connectionId===t.connectionId)),i="data-realtime-collab-locked";for(const e of o){const t=this.getDOMBlockById(e.blockId);if(!t)continue;const o=t.querySelectorAll(`[contenteditable="false"][${i}]`);t.classList.remove(this.CSS.lockedBlock),o.forEach(e=>{e.setAttribute("contenteditable","true"),e.removeAttribute(i)}),this.config.overrideStyles?.lockedBlockClass&&t.classList.remove(this.config.overrideStyles.lockedBlockClass)}for(const e of n){const t=this.getDOMBlockById(e.blockId);t&&(t.querySelectorAll('[contenteditable="true"]').forEach(e=>{e.setAttribute("contenteditable","false"),e.setAttribute(i,"")}),t.classList.add(this.CSS.lockedBlock),this.config.overrideStyles?.lockedBlockClass&&t.classList.add(this.config.overrideStyles.lockedBlockClass))}}compareToolsData(e,t){return function e(t,o){if(typeof t!=typeof o)return!1;if("object"!=typeof t||null===t||null===o)return t===o;const n=Object.keys(t),i=Object.keys(o);if(n.length!==i.length)return!1;for(const s of n){if(!i.includes(s))return!1;if(!e(t[s],o[s]))return!1}return!0}(e,t)}initializeCustomToolsState(){const e=this.editor.configuration.data?.blocks??[];for(const t of e)this.config.toolsWithDataCheck.includes(t.type)&&(this._customToolsInternalState[t.id]={data:t.data,tunes:t.tunes??{}})}setupStyleElement(){this.editorStyleElement.setAttribute("data-realtime-collab-styles",""),this.getEditorHolder()?.insertAdjacentElement("afterbegin",this.editorStyleElement)}getContentAndBlockIdFromNode(e){if(!this.isNodeInsideOfEditor(e))return null;let t=e.parentElement;const o=e=>e?.classList.contains(this.EditorCSS.blockContent)&&e?.parentElement?.classList.contains(this.EditorCSS.baseBlock)&&e?.parentElement.hasAttribute(this.blockIdAttributeName);for(;t&&!o(t);)t=t.parentElement;if(!t)return null;const n=t.parentElement?.getAttribute(this.blockIdAttributeName);return n?{contentElement:t,blockId:n}:null}getBoundingClientRectForSelection(e,t,o){const n=document.createRange(),i=Math.min(t,o),s=Math.max(t,o);return n.setStart(e,i),n.setEnd(e,s),n.getClientRects()}isNodeInsideOfEditor(e){const t=this.editor?.ui?.nodes?.redactor;if(t instanceof HTMLElement)return t.contains(e);const o=this.editor?.configuration?.holder;if(o&&"string"==typeof o)return document.getElementById(o)?.contains(e);let n=e.parentElement;for(;n&&n!==document.body;){const e=n.getAttribute(this.blockIdAttributeName),t=n.classList.contains(this.EditorCSS.baseBlock),o=e&&Boolean(this.editor.blocks.getById(e));if(t&&o)return!0;n=n.parentElement}return!1}getElementXPath(e,t=!1){let o=e;const n=[];for(;o.parentNode instanceof HTMLElement&&!o.classList.contains(this.EditorCSS.editorRedactor);){const e=o.getAttribute(this.blockIdAttributeName);let i=o.localName.toLowerCase();if(e&&(i+=`[${this.blockIdAttributeName}='${e}']`),(!t||!e)&&o.previousElementSibling){let e=o,t=1;for(;e=e.previousElementSibling;)t++;i+=`:nth-child(${t})`}n.unshift(i),o=o.parentNode}return n.unshift(`.${this.EditorCSS.editorRedactor}`),n.join(" > ")}getNodeRelativeChildIndex(e){const{parentElement:t}=e;if(!t)return null;for(let o=0;o<t.childNodes.length;o++)if(e===t.childNodes[o])return o;return null}applyNeccessaryChanges(e,t){if("table"===e.name)e.holder.querySelectorAll(`.${this.EditorCSS.table.row}`).forEach((e,o)=>{const n=Array.from(e.querySelectorAll(`.${this.EditorCSS.table.cell}`));if(!n.every(e=>!e.textContent?.trim()))return;const i=t.data?.content;i instanceof Array&&i.splice(o,0,n.map(e=>e.textContent))})}calculateRelativeRects(e,t,o){const n=o.clientWidth;if(t===n)return e;const i=n<t;if(e.at(0),i);else for(const t of e);return[]}}return n.default})());